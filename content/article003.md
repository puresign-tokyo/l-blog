# サイレントセレナからコードをコピペしているという話

えるろだはサイレントセレナからコードをコピペしています。これについて詳しく話していきます。

## サイレントセレナってすごいんすよ

### サイレントセレナってな～に？

サイレントセレナは [silentselene.net](https://silentselene.net) にて稼働している現行東方スコアボードです。
このサイトは投稿されたリプレイに対して最終スコアを表示するだけでなく各面についての情報[^1]もでるのです。
実はこれって結構すごいことなんです。

[^1]: 例えば4面終わりのグレイズ数とか

### 各面終わりの情報を手に入れられることの何がすごいのか

実は永夜抄以降[^2]のリプレイファイルは最終スコアなどのデータはリプレイファイルの末尾にShiftJISでデコードできる形の平文で詰まっています。
![リプレイバイナリ](/content/article003/replay_binary.png "ロゴ")

[^2]: 旧ロイヤルフレアは紅魔郷と妖々夢のみリプレイ内部をデコードしてパースし、それ以外はこの末尾の平文を使用していた。よって旧ロイヤルフレアでは最終結果のみが表示されていた。

ただしこの平文はIT意識の高い人向けにZUNが提供しているもので、ゲームの処理では使用されません。
ゲーム内で使用されるデータはこの末尾データではなくリプレイ内部のデータであり、圧縮されています。よって各面の進行の情報を手に入れるのは通常は困難なはずです。

## やべーことしてるなって思って凸った

サイレントセレナのコードは [Github](https://github.com/n-rook/thscoreboard) にて管理されています。
とりあえずコードを読んだところ次のような処理を行っていました。
まず32th-systemさんが作った [tsadecode](https://github.com/32th-System/py-tsadecode.git) というものを使ってリプレイファイル全体を圧縮された状態から戻します。
そのあとに [Kaitai Struct](https://kaitai.io/) というバイナリ解析ライブラリの形式に則って書かれた [ksyファイル](https://github.com/n-rook/thscoreboard/tree/main/ref/threp-ksy) をもとに事前に作成しておいた [Pythonファイル](https://github.com/n-rook/thscoreboard/tree/main/project/thscoreboard/replays/kaitai_parsers) をもとにリプレイを解析していました。

自分は [tsadecode](https://github.com/32th-System/py-tsadecode.git) の関数に使われる具体的な数値の出所が分からず、 [ZUNcode](https://discord.gg/fvPJvHJ) というDiscordサーバで一次ソースについて海外ニキたちに聞きました。
しかしどうやら一次ソースはサイレントセレナだったようで、ここからコードをそのまま拝借することにしました。

## 著作権的に大丈夫なんすか

### tsadecode

まず [tsadecode](https://github.com/32th-System/py-tsadecode.git) について、これはパブリックドメインです。つまり32th-Systemさんは権利を放棄することを表明しているので自由にコードを使うことができます。なので32th-Systemさんに聞かずに勝手にえるろだに組み込むことが可能です。

### サイレントセレナのksyファイル

次にサイレントセレナの [ksyファイル](https://github.com/n-rook/thscoreboard/tree/main/ref/threp-ksy) 群について、これは [Apache License 2.0](https://github.com/n-rook/thscoreboard/blob/main/LICENSE) です。これは大雑把に以下のような制限を守れば勝手にコードを組み込むことができるというライセンスです。

- 勝手に組み込んだことが分かるように、組み込んだポイントに [Apache License 2.0](https://github.com/n-rook/thscoreboard/blob/main/LICENSE) の条文をコピー
- 独自に改造した点があればその旨を表記
- NOTICEファイルがあれば適宜その内容もコピー
  - サイレントセレナにはない

上記項目をえるろだは満たしているので自分はサイレントセレナのコードをコピペすることが可能です。

一応OSSライセンスではライセンスの波及という概念があり、組み込んだ場合はそのソフトウェア全体も同一のライセンスに設定しなければならないというものもあります。
これはみんなでコミュニティ全体をより良いものにしていこうという理念によるものです。
みんなでソフトウェアの中身を公開してお互いを助け合えばより良い世界になるはずだという考え方ですね。[^3]

[^3]: IT企業としてはこのようなライセンスの製品をコード社外秘のソフトウェアに組み込んだ場合、社外秘を出さなければいけないことになるためダルい。

ただし [Apache License 2.0](https://github.com/n-rook/thscoreboard/blob/main/LICENSE) はライセンスの波及という概念がないです。
つまり本来えるろだは `Apache License 2.0` にしなくてもよいです。
しかし東方コミュニティに貢献しようという理念[^4]のもと [Apache License 2.0](https://github.com/puresign-tokyo/l-uploader/blob/main/LICENSE) にしています。

[^4]: 本音は本当に `Apache Lisence 2.0` がライセンスの波及が無いか怖かったから。条文は読んだけどやっぱり怖いものは怖いんです…

## まぁ支えあいの世の中ってことっすわ

とはいえ勝手に拝借するだけなのはなんか嫌です。自分もサイレントセレナに貢献しています。
一応日本人として、サイレントセレナの日本語化対応をメインで行いつつ、バグ報告やバグ修正の提出をしていたりします。お借りした分、恩返しできるとよいですね。

## まとめ

えるろだがプレイ進行を表示できるのはサイレントセレナの開発者たちのおかげです。
もちろん開発者たちは英語圏の人間なので拙い英語で会話しています。それでも日本人の自分の話に付き合ってくれて本当にありがたい限りです。
これからもお互い東方コミュニティの発展に尽力できるとよいですね。